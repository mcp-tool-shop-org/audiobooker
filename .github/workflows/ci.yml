name: CI

on:
  push:
    branches: [ main ]
    paths:
      - 'audiobooker/**'
      - 'tests/**'
      - 'pyproject.toml'
  pull_request:
    branches: [ main ]
    paths:
      - 'audiobooker/**'
      - 'tests/**'
      - 'pyproject.toml'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install -e .[dev]

    - name: Import gate
      run: |
        python -c "
        import audiobooker
        from audiobooker.renderer.engine import render_chapter, render_project
        from audiobooker.renderer.protocols import TTSEngine, SynthesisResult, FFmpegRunner, RunResult
        from audiobooker.renderer.ffmpeg_runner import RealFFmpegRunner
        from audiobooker.renderer.output import assemble_m4b, AssemblyResult, generate_chapter_metadata
        from audiobooker.casting.voice_registry import validate_voices, get_available_voices
        print('All imports OK')
        "

    - name: Run tests (hermetic only)
      run: pytest tests/ -v --ignore=tests/test_e2e_smoke.py -k "not requires_voice_soundboard and not requires_ffmpeg"

    - name: Test CLI commands
      run: |
        audiobooker --help
        audiobooker voices --help || true
        audiobooker new --help || true
